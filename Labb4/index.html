<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Chat App</title>

  <link rel="stylesheet" href="styles.css?v=1.0">

</head>

<body>
  <h1>Chat app</h1>

  <div id="chatarea">
    <h2 id="chatroom">Chat Room:</h2>
    <div id="box"></div>
  </div>
  <p>Enter chat and press enter.</p>
  <input id="input" placeholder="Your Message Here"/>

  <p id="heading"></p>
</body>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.23.0.min.js"></script>


<!-- Instantiate PubNub -->
<script>

var pubnub = new PubNub({

publishKey: 'pub-c-701807e9-652b-4981-9bef-a6024c7daefd',

subscribeKey: 'sub-c-543d2354-6bff-11e9-81d5-56c3556875f9'

});

var currentHeading = 0;

function getDirection(degrees) {

  if(degrees <= 45 || degrees > 315) {
    return 'north';
  } else if(degrees > 45 && degrees < 135) {
    return 'east';
  } else if(degrees >= 135 && degrees < 225) {
    return 'south';
  } else {
    return 'west'
  }
}
//initialization

var box = document.getElementById("box");
var input = document.getElementById("input");
var channel = getDirection(currentHeading);
document.getElementById("chatroom").innerHTML = 'Chat Room: ' + channel;

pubnub.subscribe({channels: [channel]}); // Subscribe to a channel.
pubnub.addListener({message: function(m) {
     box.innerHTML = box.innerHTML + 'channel ' + channel + ': ' + (''+m.message).replace( /[<>]/g, '' ) + '<br>'; // Add message to page.
}});


window.addEventListener("deviceorientation", deviceOrientationListener, true);

// Get event data
function deviceOrientationListener(event) {
  var alpha   = event.alpha; //z axis rotation [0,360)
  var beta     = event.beta; //x axis rotation [-180, 180]
  var gamma   = event.gamma; //y axis rotation [-90, 90]

  //Check if absolute values have been sent
  if (typeof event.webkitCompassHeading !== "undefined") {
    alpha = event.webkitCompassHeading; //for iOS devices
    var heading = alpha
    document.getElementById("heading").innerHTML = heading.toFixed([0]);
    currentHeading = heading.toFixed([0]);
  }
  else {
    var heading = 360 - alpha; //heading [0, 360)
    document.getElementById("heading").innerHTML = heading.toFixed([0]);
    currentHeading = heading.toFixed([0]);
  }
  if(channel != getDirection(currentHeading)) {
    //change channel
    channel = getDirection(currentHeading);
    document.getElementById("chatroom").innerHTML = 'Chat Room: ' + channel;
  }
  pubnub.unsubscribeAll(); //unsubscripe to previous channel
  pubnub.subscribe({channels: [channel]}); // Subscribe to the new channel
  pubnub.addListener({message: function(m) {
       box.innerHTML = box.innerHTML + 'channel ' + channel + ': ' + (''+m.message).replace( /[<>]/g, '' ) + '<br>'; // Add message to page.
  }});

};


function publish(e) {

  if(e.keyCode == 13 || e.charCode == 13) {
    pubnub.publish({channel : channel, message : input.value, x : (input.value='')})
  }
};

input.addEventListener('keypress', publish, true);

</script>

</html>
