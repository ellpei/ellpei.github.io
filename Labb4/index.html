<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>Chat App</title>

  <link rel="stylesheet" href="styles.css?v=1.0">

</head>

<body>
  <h1>Chat app</h1>

  <div id="chatarea">
    <h2 id="chatroom">Chat Room:</h2>
    <div id="box"></div>
  </div>
  <p>Enter chat and press enter.</p>
  <div id="input-container">
  <input id="input" placeholder="Your Message Here"/><button id="sendMsg">Send</button>
</div>
  <p id="heading"></p>
</body>

<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.23.0.min.js"></script>


<!-- Instantiate PubNub -->
<script>

var pubnub = new PubNub({

publishKey: 'pub-c-701807e9-652b-4981-9bef-a6024c7daefd',

subscribeKey: 'sub-c-543d2354-6bff-11e9-81d5-56c3556875f9'

});

function getDirection(degrees) {

  if(degrees <= 45 || degrees > 315) {
    return 'north';
  } else if(degrees > 45 && degrees < 135) {
    return 'east';
  } else if(degrees >= 135 && degrees < 225) {
    return 'south';
  } else {
    return 'west'
  }
}
//initialization

var channelListener = {
  message: function(m) {
    box.innerHTML = box.innerHTML + 'channel ' + currentchannel + ': ' + (''+m.message).replace( /[<>]/g, '' ) + '<br>'; // Add message to page.
  }
};
var box = document.getElementById("box");
var input = document.getElementById("input");
var currentchannel = getDirection(0);
document.getElementById("chatroom").innerHTML = 'Chat Room: ' + currentchannel;

pubnub.subscribe({channels: [currentchannel]}); // Subscribe to a channel.
pubnub.addListener(channelListener);
//event listeners
document.getElementById("sendMsg").addEventListener("click", sendMessage);
window.addEventListener("deviceorientation", deviceOrientationListener, true);
input.addEventListener('keypress', publish, true);

var channelListener = {
    message: function() {
      box.innerHTML = box.innerHTML + 'channel ' + currentchannel + ': ' + (''+m.message).replace( /[<>]/g, '' ) + '<br>'; // Add message to page.
    }
}
// Get event data
function deviceOrientationListener(event) {
  var alpha   = event.alpha; //z axis rotation [0,360)
  var beta     = event.beta; //x axis rotation [-180, 180]
  var gamma   = event.gamma; //y axis rotation [-90, 90]
  var currentHeading;
  //Check if absolute values have been sent
  if (typeof event.webkitCompassHeading !== "undefined") {
    alpha = event.webkitCompassHeading; //for iOS devices
    var heading = alpha
    document.getElementById("heading").innerHTML = heading.toFixed([0]);
    currentHeading = heading.toFixed([0]);
  }
  else {
    var heading = 360 - alpha; //heading [0, 360)
    document.getElementById("heading").innerHTML = heading.toFixed([0]);
    currentHeading = heading.toFixed([0]);

  }
  //change channel
  currentchannel = getDirection(currentHeading);
  pubnub.unsubscribeAll(); //unsubscribe to previous channel
  pubnub.subscribe({channels: [currentchannel]}); // Subscribe to the new channel
  //pubnub.removeListener(channelListener);
  //pubnub.addListener(channelListener);
  document.getElementById("chatroom").innerHTML = 'Chat Room: ' + currentchannel;
};



function sendMessage() {
  pubnub.publish({channel : currentchannel, message : input.value, x : (input.value='')})
}
function publish(e) {

  if(e.keyCode == 13 || e.charCode == 13) {
    pubnub.publish({channel : currentchannel, message : input.value, x : (input.value='')})
  }
};


</script>

</html>
